PROG=FreeOberon
OS=linux
VOC=../data/bin/voc/bin/voc
CC=gcc
VER=1.0.4

all: prepare voc $(PROG) install

fo: $(PROG)

$(PROG): $(PROG).sym
	$(CC) -fPIC -g -I ../data/bin/voc/C/include \
		-o $(PROG) $(PROG).o Graph.o Allegro.o \
		OV.o Editor.o Term.o Terminal.o \
		EditorText.o Signals.o Pthread.o Semaphore.o \
    Config.o Term/Term.o Semaphore/Semaphore.o \
    al_icon/al_icon.o \
		../data/bin/voc/lib/libvoc-OC.a -lpthread \
    `allegro-config --libs` -lloadpng && \
		mv $(PROG) ..

$(PROG).sym: $(PROG).Mod EditorText.sym Terminal.sym OV.sym \
		Editor.sym Term.sym Graph.sym al_icon/al_icon.o
	$(VOC) -OC -cesF -m $(PROG).Mod

OV.sym: OV.Mod Terminal.sym Graph.sym
	$(VOC) -OC -cesF OV.Mod

Editor.sym: Editor.Mod Terminal.sym EditorText.sym OV.sym Graph.sym
	$(VOC) -OC -cesF Editor.Mod

Term.sym: Term.Mod Term/Term.o
	$(VOC) -OC -cesF Term.Mod

Terminal.sym: Terminal.Mod Graph.sym
	$(VOC) -OC -cesF Terminal.Mod

EditorText.sym: EditorText.Mod Config.sym
	$(VOC) -OC -cesF EditorText.Mod

Config.sym: Config_$(OS).Mod
	$(VOC) -OC -cesF Config_$(OS).Mod

Term/Term.o: Term/Term_$(OS).c
	$(CC) -c Term/Term_$(OS).c -o Term/Term.o

Graph.sym: Graph.Mod Allegro.sym Signals.sym
	$(VOC) -OC -cesF Graph.Mod

Allegro.sym: Allegro.Mod
	$(VOC) -OC -cesF Allegro.Mod

Signals.sym: Signals.Mod Semaphore.sym Pthread.sym
	$(VOC) -OC -cesF Signals.Mod

Pthread.sym: Pthread.Mod
	$(VOC) -OC -cesF Pthread.Mod

Semaphore.sym: Semaphore.Mod Semaphore/Semaphore.o
	$(VOC) -OC -cesF Semaphore.Mod

Semaphore/Semaphore.o: Semaphore/Semaphore.c
	$(CC) -c Semaphore/Semaphore.c -o Semaphore/Semaphore.o

al_icon/al_icon.o: al_icon/al_icon.c
	$(CC) -c al_icon/al_icon.c -o al_icon/al_icon.o

.PHONY: clean cleanfo cleanall install pack prepare run

cleanfo:
	rm -f *.c *.h *.o *.sym Term/*.o Semaphore/*.o al_icon/*.o .tmp..* \
		../Programs/.tmp..*

clean: cleanfo
	make -C ../data/bin/voc/src clean

cleanall: clean
	rm -f ../$(PROG) ../$(PROG).exe
	make -C ../data/bin/voc/src cleanall

prepare:
	chmod +x ../data/bin/*.sh ../data/bin/voc/src/*.sh

pack: clean prepare
	rm -rf Makefile ../$(PROG) ../*.exe ../*.dll \
		../data/bin/voc/src/*.exe
	ln -s Makefile_linux Makefile
	$(eval TMPDIR := $(shell mktemp -d /tmp/FreeOberon_XXXXXX))
	mkdir -p $(TMPDIR)/FreeOberon
	cp -r ../* $(TMPDIR)/FreeOberon
	rm -rf $(TMPDIR)/FreeOberon/data/bin/mingw32 \
		$(TMPDIR)/FreeOberon/data/bin/voc/bin \
		$(TMPDIR)/FreeOberon/data/bin/voc/C \
		$(TMPDIR)/FreeOberon/data/bin/voc/lib
	tar czf ../../FreeOberon_v$(VER).tar.gz -C $(TMPDIR) FreeOberon
	rm -rf $(TMPDIR)

voc:
	make -C ../data/bin/voc/src

run: fo

install:
	cp Graph.sym Allegro.sym ../data/bin/voc/C/sym
	cp Graph.h Allegro.h Allegro.h0 ../data/bin/voc/C/include
	cp Graph.o Allegro.o Signals.o Semaphore.o Pthread.o ../data/bin/voc/lib
	mkdir -p ../data/bin/voc/lib/Semaphore
	cp Semaphore/Semaphore.o ../data/bin/voc/lib/Semaphore
